<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YSU â€¢ Penguin Games</title>

<!-- paths are relative to /docs -->
<link rel="preload" href="./assets/ysu-bg.png" as="image" />
<style>
  :root{
    --card-w: min(92vw, 980px);
    --card-h: clamp(380px, 56vw, 640px);
    --overlay-dot: 72px; /* NOT USED DIRECTLY, FOR REFERENCE ONLY */
  }

  html,body{
    height:100%;
    margin:0;
    background:#0e1217;
    color:#e9eef7;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }

  /* Background */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 800px at 75% 20%, rgba(255,255,255,0.06), transparent 60%),
      radial-gradient(1000px 700px at 20% 80%, rgba(255,255,255,0.06), transparent 60%),
      url("./assets/ysu-bg.png");
    background-size: cover, cover, cover;
    background-position:center;
    filter: saturate(1.05) contrast(1.03);
    z-index:-1;
  }

  .wrap{
    min-height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
    padding:22px 14px 52px;
  }

  .brand{
    margin-top:8px;
    font-weight:800;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size: clamp(20px, 2.6vw, 30px); /* bigger */
    display:flex; gap:10px; align-items:center;
    opacity:.95;
  }
  .brand .dot{
    width:10px;height:10px;border-radius:50%; background:#ff3355;
    box-shadow:0 0 10px #ff3355aa;
  }

  /* CARD with image behind the scratch */
  .card{
    position:relative;
    width:var(--card-w);
    height:var(--card-h);
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.08);
    box-shadow: 0 20px 50px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
   background: #0f141b url("./assets/ysu-bg.png?v=1") center/cover no-repeat;
  }

  .result{
    position:absolute; inset:0;
    z-index:2; /* UNDER the canvas */
    display:grid; place-items:center;
    text-align:center; padding:0 16px;
    user-select:none; pointer-events:none;
    opacity:0; transition:opacity .25s ease-out;
  }
  .result.revealed{ opacity:1; }

  .result .label{
    font-size: clamp(22px, 3.8vw, 44px);
    letter-spacing:.22em;
    font-weight:900;
    text-transform:uppercase;
    text-shadow:0 3px 12px rgba(0,0,0,.5);
  }
  .result .prize{
    margin-top:.7rem;
    font-size: clamp(16px, 2.8vw, 26px);
    letter-spacing:.06em;
    opacity:.94;
  }
  .result .code{
    margin-top:.45rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: clamp(14px, 2.4vw, 20px);
    letter-spacing:.04em;
    opacity:.9;
  }

  .hint{
    position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
    z-index:4; /* ABOVE canvas */
    font-size: clamp(16px, 2.2vw, 20px);
    letter-spacing:.08em; opacity:.95;
    text-shadow:0 2px 8px rgba(0,0,0,.6);
    pointer-events:none;
  }

  /* SCRATCH overlay on top */
  canvas#scratch{
    position:absolute; inset:0;
    width:100%; height:100%;
    display:block; cursor:crosshair;
    z-index:3; /* top */
  }

  .btnbar{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .btn{
    appearance:none;
    border:none; border-radius:12px;
    padding:12px 16px;
    font-weight:700;
    letter-spacing:.02em;
    color:#0b1016;
    background:#e2b857;
    box-shadow: 0 8px 18px #e2b85733, inset 0 1px 0 #fff3;
    cursor:pointer;
  }
  .btn[hidden]{ display:none; }

  .notice{
    font-size: clamp(18px, 2.2vw, 22px); /* bigger */
    opacity:.95; margin-top:12px; text-align:center; max-width:var(--card-w);
  }
  .notice b, .notice strong { color: #ffe08a; }

  .already{
    background:#1d242d;
    border:1px solid #ffffff18;
    padding:14px 16px; border-radius:12px;
    margin-top:12px;
    font-size: clamp(18px, 2.2vw, 22px); /* bigger */
    opacity:.96;
    text-align:center;
    max-width: var(--card-w);
  }

  .ribbon{
    position:fixed; top:12px; left:50%;
    transform:translateX(-50%);
    background:#151b22; border:1px solid #ffffff14;
    color:#e8edf6; padding:10px 14px; border-radius:12px;
    font-size: clamp(16px, 2vw, 20px);
    letter-spacing:.02em;
    display:none;
  }
</style>
</head>
<body>
  <div id="globalBanner" class="ribbon"></div>

  <div class="wrap">
    <div class="brand"><span class="dot"></span>YSU â€¢ PENGUIN GAMES</div>

<div class="card" id="card">
  <!-- new: actual image element -->
  <img class="card-bg" src="./assets/ysu-bg.png" alt="Card background" />

  <div class="result" id="result">
    <div class="label" id="label">SCRATCH TO REVEAL</div>
    <div class="prize" id="prize"></div>
    <div class="code"  id="code"></div>
  </div>

  <div class="hint" id="hint">Scratch the gold to reveal your result</div>
  <canvas id="scratch"></canvas>
</div>

    <div class="already" id="already" hidden>
      You already played on this device. Thanks for trying!
    </div>

    <div class="btnbar">
      <button class="btn" id="resetBtn" hidden>Reset this device (debug)</button>
      <button class="btn" id="rerollBtn" hidden>Re-roll (debug)</button>
    </div>

    <div class="notice">
      Tip: Follow <strong>@YSUHousing</strong> for the next giveaway.
    </div>
  </div>

<script>
/* ============= Config ============= */
const CSV_PATH   = "./decks/HRLVYPZ.csv"; // REAL winners (PRIZE,CODE)
const TOTAL_CARDS = 50;                   // winners + â€œSORRYâ€
const STORAGE_KEY = "pg_claim_v1";        // per-device stored result
const SCRIPT_URL  = "https://script.google.com/macros/s/AKfycbyxXG0lqYRWF-yNl72EXjmck-U4xU-aTR8OvPtvPw9D1XwPEJ317mELPk55QpEa0ilArQ/exec";

// Debug: add ?debug=1 â€” shows real winners/codes but NEVER calls the Sheet
const params = new URLSearchParams(location.search);
const DEBUG = params.get("debug") === "1";

/* ============= Helpers ============= */
const $ = s => document.querySelector(s);
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function claimCodeJSONP(code, cb){
  const cbName = "jsonp_cb_" + Math.random().toString(36).slice(2);
  window[cbName] = (res) => { try{ cb(res); } finally {
    delete window[cbName];
    tag.remove();
  }};
  const tag = document.createElement("script");
  tag.src = `${SCRIPT_URL}?code=${encodeURIComponent(code)}&callback=${encodeURIComponent(cbName)}`;
  document.body.appendChild(tag);
}

/* ============= Data load ============= */
async function loadWinners(){
  try{
    const res = await fetch(CSV_PATH, {cache:"no-store"});
    if(!res.ok) throw new Error("CSV fetch failed");
    const txt = await res.text();
    const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const winners = [];
    for(const line of lines){
      const [prizeRaw, codeRaw] = line.split(",").map(s=>s?.trim());
      if(!prizeRaw || !codeRaw) continue;
      winners.push({ prize: prizeRaw, code: codeRaw });
    }
    return winners;
  }catch(e){
    console.warn("CSV load error:", e);
    return [];
  }
}

function buildLocalDeck(winners){
  const deck = [];
  for(const w of winners) deck.push({type:"WIN", prize:w.prize, code:w.code});
  const losersNeeded = Math.max(0, TOTAL_CARDS - deck.length);
  for(let i=0;i<losersNeeded;i++) deck.push({type:"LOSE"});
  return shuffle(deck);
}

/* ============= Storage ============= */
const getStored = ()=>{ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"null"); }catch{ return null; } };
const setStored = (o)=> localStorage.setItem(STORAGE_KEY, JSON.stringify(o));
const clearStored = ()=> localStorage.removeItem(STORAGE_KEY);

/* ============= Render ============= */
function renderResultText(obj){
  $("#label").textContent = (obj.type === "WIN") ? "WIN!" : "SORRY!";
  $("#prize").textContent = (obj.type === "WIN") ? obj.prize : "";
  $("#code").textContent  = (obj.type === "WIN") ? obj.code  : "";
}

/* ============= Scratch overlay ============= */
const BRUSH_PX = 72;          // bigger brush = easier scratch (try 64â€“80)
const REVEAL_THRESHOLD = 0.32; // ~32% cleared triggers reveal

function drawGold(ctx, w, h){
  const g1 = ctx.createLinearGradient(0,0,w,h);
  g1.addColorStop(0,  "#f3cf6b");
  g1.addColorStop(.45,"#b38728");
  g1.addColorStop(.55,"#ffe08a");
  g1.addColorStop(1,  "#9d7a2d");
  ctx.fillStyle = g1; ctx.fillRect(0,0,w,h);
  const n = ctx.createLinearGradient(0,h,0,0);
  n.addColorStop(0,"rgba(255,255,255,.08)");
  n.addColorStop(1,"rgba(0,0,0,.08)");
  ctx.globalCompositeOperation="overlay";
  ctx.fillStyle=n; ctx.fillRect(0,0,w,h);
  ctx.globalCompositeOperation="source-over";
}

function initScratch(onReveal){
  const canvas = $("#scratch");
  const card   = $("#card");
  const hint   = $("#hint");
  const result = $("#result");

  const dpr = Math.max(1, window.devicePixelRatio || 1);
  function sizeCanvas(){
    const r = card.getBoundingClientRect();
    canvas.style.width  = r.width + 'px';
    canvas.style.height = r.height + 'px';
    canvas.width  = Math.floor(r.width  * dpr);
    canvas.height = Math.floor(r.height * dpr);
  }
  sizeCanvas();
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  drawGold(ctx, canvas.width/dpr, canvas.height/dpr);

  let down = false, last = null, revealed = false;

  function scratchAt(x, y){
    ctx.save();
    ctx.globalCompositeOperation = 'destination-out';
    ctx.lineJoin = ctx.lineCap = 'round';
    ctx.lineWidth = BRUSH_PX;
    if(last){
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(x, y);
      ctx.stroke();
    } else {
      ctx.beginPath();
      ctx.arc(x, y, BRUSH_PX/2, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
    last = {x,y};
  }

  const pos = (e)=>{
    const rect = canvas.getBoundingClientRect();
    const pt = e.touches ? e.touches[0] : e;
    return { x: pt.clientX - rect.left, y: pt.clientY - rect.top };
  };

  function downH(e){ down = true; last = null; const p = pos(e); scratchAt(p.x,p.y); }
  function moveH(e){ if(!down) return; const p = pos(e); scratchAt(p.x,p.y); }
  function upH(){
    down = false; last = null;

    // sample for speed: every 8th pixel (4 * 8)
    const {width, height} = canvas;
    const data = ctx.getImageData(0,0,width,height).data;
    let clear=0, total=0;
    for(let i=3;i<data.length;i+=32){ total++; if(data[i]===0) clear++; }
    const cleared = clear/total;

    if(!revealed && cleared >= REVEAL_THRESHOLD){
      revealed = true;
      result.classList.add("revealed");
      hint.style.display = "none";
      canvas.style.pointerEvents = "none";
      canvas.style.transition = "opacity .35s ease-out";
      canvas.style.opacity = "0";
      if(typeof onReveal === "function") onReveal();
    }
  }

  // pointer + touch
  canvas.addEventListener('pointerdown', downH);
  window.addEventListener('pointermove', moveH);
  window.addEventListener('pointerup',   upH);
  canvas.addEventListener('touchstart',  e=>{ e.preventDefault(); downH(e); }, {passive:false});
  canvas.addEventListener('touchmove',   e=>{ e.preventDefault(); moveH(e); }, {passive:false});
  canvas.addEventListener('touchend',    e=>{ e.preventDefault(); upH(e);   }, {passive:false});

  // expose reset for re-roll
  return function resetOverlay(){
    canvas.style.opacity = "1";
    canvas.style.pointerEvents = "auto";
    result.classList.remove("revealed");
    hint.style.display = "block";
    sizeCanvas();
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    drawGold(ctx, canvas.width/dpr, canvas.height/dpr);
    down=false; last=null; revealed=false;
  };
}

// Helper to show SOLD OUT state
function showSoldOutUI() {
  const label  = document.querySelector("#label");
  const prize  = document.querySelector("#prize");
  const code   = document.querySelector("#code");
  const hint   = document.querySelector("#hint");
  const canvas = document.querySelector("#scratch");
  const banner = document.querySelector("#globalBanner");

  if (label) label.textContent = "SOLD OUT";
  if (prize) prize.textContent = "";
  if (code)  code.textContent  = "";

  if (hint) hint.style.display = "none";
  if (canvas) {
    canvas.style.pointerEvents = "none";
    canvas.style.opacity = 0;
  }

  if (banner) {
    banner.textContent = "All cards have been claimed. Thanks for playing!";
    banner.style.display = "block";
  }

  try { localStorage.removeItem("pg_claim_v1"); } catch {}
}
  
/* ============= Flow ============= */
(async function main(){
  $("#globalBanner").style.display = "none";

  if(DEBUG){
    $("#resetBtn").hidden = false;
    $("#rerollBtn").hidden = false;
    $("#resetBtn").onclick = ()=>{ clearStored(); location.reload(); };
  }

  const stored = getStored();
  if(stored && !DEBUG){
    renderResultText(stored);
    $("#result").classList.add("revealed");
    $("#already").hidden = false;
    $("#scratch").style.pointerEvents="none";
    $("#scratch").style.opacity=0;
    $("#hint").style.display = "none";
    return;
  }

  await rollAndRender(DEBUG);
})();

async function rollAndRender(isDebug){
  const winners = await loadWinners();
  const deck = buildLocalDeck(winners);

  let pick = deck[Math.floor(Math.random()*deck.length)] || {type:"LOSE"};
  renderResultText(pick);

  const resetOverlay = initScratch(()=>{
    if(!isDebug){
      if(pick.type === "WIN"){
        if(window.__claiming) return;
        window.__claiming = true;
claimCodeJSONP(pick.code, (res)=>{
  window.__claiming = false;

  // ðŸ”´ NEW: check if all codes are gone
  if(res && res.soldOut){
    showSoldOutUI();
    return;
  }

  if(res && res.ok){
    setStored(pick);
  }else{
    renderResultText({type:"LOSE"});
    setStored({type:"LOSE"});
  }
});

        });
      }else{
        setStored(pick);
      }
    }
  });

  if(DEBUG){
    $("#rerollBtn").onclick = ()=>{
      clearStored();
      pick = deck[Math.floor(Math.random()*deck.length)] || {type:"LOSE"};
      renderResultText(pick);
      resetOverlay();
    };
  }
}
</script>
</body>
</html>
