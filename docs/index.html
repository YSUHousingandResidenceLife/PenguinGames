<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YSU • Penguin Games</title>
<link rel="preload" href="./docs/assets/ysu-bg.png" as="image" />
<style>
  :root{
    --card-w: min(92vw, 980px);
    --card-h: clamp(360px, 56vw, 600px);
    --overlay-dot: 44px; /* “scratch brush” size */
  }

  html,body{
    height:100%;
    margin:0;
    background:#0e1217;
    color:#e9eef7;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }

  /* Background */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 800px at 75% 20%, rgba(255,255,255,0.06), transparent 60%),
      radial-gradient(1000px 700px at 20% 80%, rgba(255,255,255,0.06), transparent 60%),
      url("./docs/assets/ysu-bg.png");
    background-size: cover, cover, cover;
    background-position:center;
    filter: saturate(1.05) contrast(1.03);
    z-index:-1;
  }

  .wrap{
    min-height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
    padding:20px 14px 48px;
  }

  .brand{
    margin-top:8px;
    font-weight:700;
    letter-spacing:.06em;
    text-transform:uppercase;
    font-size:14px;
    display:flex;gap:8px;align-items:center;
    opacity:.9;
  }
  .brand .dot{
    width:8px;height:8px;border-radius:50%; background:#ff3355;
    box-shadow:0 0 8px #ff3355aa;
  }

  .card{
    width:var(--card-w);
    height:var(--card-h);
    border-radius:18px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:
      0 20px 50px rgba(0,0,0,.55),
      inset 0 1px 0 rgba(255,255,255,.04);
    position:relative;
    overflow:hidden;
    display:grid;
    place-items:center;
  }

  .result{
    z-index:1;
    text-align:center;
    user-select:none;
    pointer-events:none;
  }
  .result .label{
    font-size: clamp(20px, 3.6vw, 40px);
    letter-spacing:.2em;
    font-weight:900;
    text-transform:uppercase;
    text-shadow:0 3px 12px rgba(0,0,0,.5);
  }
  .result .prize{
    margin-top:.6rem;
    font-size: clamp(14px, 2.6vw, 24px);
    letter-spacing:.06em;
    opacity:.92;
  }
  .result .code{
    margin-top:.35rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: clamp(12px, 2.2vw, 18px);
    letter-spacing:.04em;
    opacity:.85;
  }

  /* Gold scratch overlay (no seams) */
  canvas#scratch{
    position:absolute; inset:0;
    width:100%; height:100%;
    display:block;
    cursor: crosshair;
  }

  .btnbar{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .btn{
    appearance:none;
    border:none; border-radius:10px;
    padding:10px 14px;
    font-weight:650;
    letter-spacing:.02em;
    color:#0b1016;
    background:#e2b857; /* gold */
    box-shadow: 0 8px 18px #e2b85733, inset 0 1px 0 #fff3;
    cursor:pointer;
  }
  .btn[hidden]{ display:none; }

  .notice{
    font-size:13px; opacity:.8; margin-top:6px;
  }
  .ribbon{
    position:fixed; top:10px; left:50%;
    transform:translateX(-50%);
    background:#151b22; border:1px solid #ffffff14;
    color:#e8edf6; padding:8px 12px; border-radius:10px;
    font-size:13px; letter-spacing:.02em;
    display:none; /* hidden by default on static site */
  }
  .already{
    background:#1d242d;
    border:1px solid #ffffff18;
    padding:10px 12px; border-radius:10px;
    margin-top:6px; font-size:14px; opacity:.92;
  }
</style>
</head>
<body>
  <!-- kept hidden on a static site because we can’t know global claims -->
  <div id="globalBanner" class="ribbon"></div>

  <div class="wrap">
    <div class="brand"><span class="dot"></span>YSU • PENGUIN GAMES</div>

    <div class="card" id="card">
      <div class="result" id="result">
        <div class="label" id="label">SCRATCH TO REVEAL</div>
        <div class="prize" id="prize"></div>
        <div class="code"  id="code"></div>
      </div>
      <canvas id="scratch"></canvas>
    </div>

    <div class="already" id="already" hidden>
      You already played on this device. Thanks for trying!
    </div>

    <div class="btnbar">
      <button class="btn" id="resetBtn" hidden>Reset this device (debug)</button>
      <button class="btn" id="rerollBtn" hidden>Re-roll (debug)</button>
    </div>

    <div class="notice">
      Tip: Follow <strong>@YSUHousing</strong> for the next giveaway.
    </div>
  </div>

<script>
/* ========================
   Config
======================== */
const CSV_PATH = "./docs/decks/HRLVYPZ.csv"; // your uploaded file
const TOTAL_CARDS = 50;                      // 20 winners + 30 “SORRY”
const STORAGE_KEY = "pg_claim_v1";           // per-device stored result

// Debug mode (add ?debug=1)
const params = new URLSearchParams(location.search);
const DEBUG = params.get("debug") === "1";

/* ========================
   Utilities
======================== */
const $ = sel => document.querySelector(sel);
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* ========================
   Load winners from CSV
======================== */
async function loadWinners(){
  try{
    const res = await fetch(CSV_PATH, {cache:"no-store"});
    if(!res.ok) throw new Error("CSV fetch failed");
    const txt = await res.text();
    const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    // Expect: PRIZE, CODE
    const winners = [];
    for(const line of lines){
      const [prizeRaw, codeRaw] = line.split(",").map(s=>s?.trim());
      if(!prizeRaw || !codeRaw) continue;
      // keep the exact prize text for display; code as-is
      winners.push({ prize: prizeRaw, code: codeRaw });
    }
    return winners;
  }catch(err){
    console.warn("CSV load error:", err);
    return []; // fall back gracefully
  }
}

/* ========================
   Build a local deck
   (static site = no global inventory)
======================== */
function buildLocalDeck(winners){
  // winners array length = 20 from your CSV
  const deck = [];
  // push winners
  for(const w of winners){ deck.push({type:"WIN", prize:w.prize, code:w.code}); }
  // push losers to fill to 50 total
  const losersNeeded = Math.max(0, TOTAL_CARDS - deck.length);
  for(let i=0;i<losersNeeded;i++) deck.push({type:"LOSE"});
  return shuffle(deck);
}

/* ========================
   One play per device
======================== */
function getStored(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }
  catch(e){ return null; }
}
function setStored(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}
function clearStored(){
  localStorage.removeItem(STORAGE_KEY);
}

/* ========================
   Render result
======================== */
function showResult(obj){
  const label = $("#label");
  const prize = $("#prize");
  const code  = $("#code");
  if(obj.type === "WIN"){
    label.textContent = "WIN!";
    prize.textContent = obj.prize;
    code.textContent  = obj.code;
  }else{
    label.textContent = "SORRY!";
    prize.textContent = "";
    code.textContent  = "";
  }
}

/* ========================
   Scratch overlay
======================== */
function drawGold(ctx, w, h){
  // seamless gold texture via layered gradients
  const grad1 = ctx.createLinearGradient(0,0,w,h);
  grad1.addColorStop(0,  "#f3cf6b");
  grad1.addColorStop(.45,"#b38728");
  grad1.addColorStop(.55,"#ffe08a");
  grad1.addColorStop(1,  "#9d7a2d");

  ctx.fillStyle = grad1;
  ctx.fillRect(0,0,w,h);

  // noise overlay
  const noise = ctx.createLinearGradient(0,h,0,0);
  noise.addColorStop(0,"rgba(255,255,255,.08)");
  noise.addColorStop(1,"rgba(0,0,0,.08)");
  ctx.globalCompositeOperation="overlay";
  ctx.fillStyle=noise;
  ctx.fillRect(0,0,w,h);
  ctx.globalCompositeOperation="source-over";
}

function initScratch(){
  const c = $("#scratch");
  const card = $("#card");
  const rect = card.getBoundingClientRect();
  c.width  = rect.width;
  c.height = rect.height;

  const ctx = c.getContext("2d");
  drawGold(ctx, c.width, c.height);

  let scratching = false;
  function scratch(x,y){
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath();
    ctx.arc(x, y, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--overlay-dot'))/2, 0, Math.PI*2);
    ctx.fill();
    ctx.globalCompositeOperation='source-over';
  }

  c.addEventListener('pointerdown', e=>{ scratching=true; scratch(e.offsetX, e.offsetY); });
  c.addEventListener('pointermove', e=>{ if(scratching) scratch(e.offsetX, e.offsetY); });
  window.addEventListener('pointerup', ()=> scratching=false);

  // Make overlay ignore events after ~60% cleared
  let clearedCheck;
  c.addEventListener('pointerup', ()=>{
    clearTimeout(clearedCheck);
    clearedCheck = setTimeout(()=>{
      const pixels = ctx.getImageData(0,0,c.width,c.height).data;
      let transparent = 0;
      for(let i=3;i<pixels.length;i+=4){
        if(pixels[i]===0) transparent++;
      }
      const percent = transparent / (c.width*c.height) * 100;
      if(percent > 60){
        c.style.pointerEvents = "none";
        c.style.opacity = 0;
        c.style.transition = "opacity .35s ease-out";
      }
    }, 80);
  }, {passive:true});
}

/* ========================
   Main
======================== */
(async function main(){
  // Hide global claimed banner on static site
  $("#globalBanner").style.display = "none";

  // Debug controls
  if(DEBUG){
    $("#resetBtn").hidden = false;
    $("#rerollBtn").hidden = false;
    $("#resetBtn").onclick = ()=>{ clearStored(); location.reload(); };
    $("#rerollBtn").onclick = ()=>{ clearStored(); rollAndRender(true); };
  }

  // If already played on this device, show stored & disable overlay
  const existing = getStored();
  if(existing){
    showResult(existing);
    $("#already").hidden = false;
    // disable scratching
    $("#scratch").style.pointerEvents="none";
    $("#scratch").style.opacity=0;
    return;
  }

  // Not played: roll & render
  await rollAndRender(false);
})();

async function rollAndRender(isDebug){
  const winners = await loadWinners();
  const deck    = buildLocalDeck(winners);

  // Draw scratch overlay
  initScratch();

  // Random pick (mix of winners/losers)
  const pick = deck[Math.floor(Math.random()*deck.length)] || {type:"LOSE"};

  // If winner: ensure we have a code/prize (fallback safe)
  let result = pick;
  if(pick.type==="WIN"){
    // if somehow missing prize/code, fallback to LOSER to avoid empty UI
    if(!pick.prize || !pick.code) result = {type:"LOSE"};
  }

  // Render immediately (under the gold)
  showResult(result);

  // On a real play (not debug), store and lock this device
  if(!isDebug){
    setStored(result);
  }
}
</script>
</body>
</html>
