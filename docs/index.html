<script>
/* =========================
   CONFIG
   ========================= */
const BACKGROUND_IMAGE_URL = "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop"; 
const WIN_PROBABILITY = 0.20;  // 20% chance of winning
const EVENT_MODE = "auto-week";
const FIXED_EVENT_ID = "ysu-event-1";

/* Prize pool weights (approximate distribution) */
const PRIZES = [
  {label:"WATER BOTTLE", weight:7},
  {label:"CROSS BAG", weight:8},
  {label:"LANYARD", weight:5}
];

/* =========================
   EVENT ID
   ========================= */
function getEventId(){
  const url = new URL(location.href);
  const override = url.searchParams.get("event");
  if (override) return `ev-${override}`;
  const d = new Date();
  if (EVENT_MODE==="auto-day") return `ev-${d.getUTCFullYear()}${d.getUTCMonth()+1}${d.getUTCDate()}`;
  if (EVENT_MODE==="auto-week"){
    const tmp=new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    const dayNum=(tmp.getUTCDay()+6)%7;
    tmp.setUTCDate(tmp.getUTCDate()-dayNum+3);
    const firstThursday=new Date(Date.UTC(tmp.getUTCFullYear(),0,4));
    const week=1+Math.round(((tmp-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);
    return `ev-${d.getUTCFullYear()}-w${String(week).padStart(2,"0")}`;
  }
  return `ev-${FIXED_EVENT_ID}`;
}
const EVENT_ID = getEventId();
document.getElementById('pillEvent').textContent = `Event: ${EVENT_ID}`;

/* =========================
   ONE PLAY PER DEVICE
   ========================= */
const PLAY_KEY = `pg_play_${EVENT_ID}`;
let stored = localStorage.getItem(PLAY_KEY);
let result;

function randomCode(len=6){
  const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let out="YSU-";
  const buf=new Uint32Array(len);
  crypto.getRandomValues(buf);
  for(let i=0;i<len;i++) out+=chars[buf[i]%chars.length];
  return out;
}

/* Pick random prize weighted */
function pickPrize(){
  const total = PRIZES.reduce((a,p)=>a+p.weight,0);
  let r = Math.random()*total;
  for(const p of PRIZES){
    if(r<p.weight) return p.label;
    r-=p.weight;
  }
  return PRIZES[0].label;
}

if (stored){
  try{ result=JSON.parse(stored);}catch{}
}
if(!result){
  const win = Math.random()<WIN_PROBABILITY;
  result = {
    prize: win ? pickPrize() : "SORRY",
    code: randomCode()
  };
  localStorage.setItem(PLAY_KEY, JSON.stringify(result));
}

/* =========================
   UI
   ========================= */
const stage=document.getElementById("stage");
stage.style.backgroundImage=`url("${BACKGROUND_IMAGE_URL}")`;

const prizeEl=document.getElementById("prize");
const codeEl=document.getElementById("code");
const already=document.getElementById("already");

prizeEl.textContent = result.prize==="SORRY" ? "ðŸ˜… SORRY" : "ðŸŽ‰ "+result.prize;
prizeEl.classList.add(result.prize==="SORRY"?"t-lose":"t-win");
codeEl.textContent=result.code;

if(stored) already.classList.remove("hidden");

/* =========================
   GOLD SCRATCH OVERLAY
   ========================= */
const cvs=document.getElementById("overlay");
const ctx=cvs.getContext("2d");
let down=false,revealed=false;

function sizeCanvas(){
  const r=stage.getBoundingClientRect();
  cvs.width=Math.round(r.width*devicePixelRatio);
  cvs.height=Math.round(r.height*devicePixelRatio);
  cvs.style.width=r.width+"px";
  cvs.style.height=r.height+"px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  drawGold(r.width,r.height);
}
function drawGold(w,h){
  const g1=ctx.createLinearGradient(0,0,w,h);
  g1.addColorStop(0.00,"#b8860b");
  g1.addColorStop(0.25,"#ffd700");
  g1.addColorStop(0.50,"#fff8dc");
  g1.addColorStop(0.75,"#ffd700");
  g1.addColorStop(1.00,"#b8860b");
  ctx.globalCompositeOperation="source-over";
  ctx.fillStyle=g1; ctx.fillRect(0,0,w,h);

  // Clean solid overlay (no lines)
  ctx.globalCompositeOperation="source-over";
  ctx.font=`800 ${Math.max(20,Math.floor(w*0.06))}px Inter,system-ui,sans-serif`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillStyle="rgba(0,0,0,.35)";
  ctx.fillText("SCRATCH TO REVEAL", w/2, h/2);
  ctx.globalCompositeOperation="destination-out";
}
function pos(e){const r=cvs.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}
function scratch(e){const p=pos(e);const rad=Math.max(18,cvs.width/devicePixelRatio*0.035);ctx.beginPath();ctx.arc(p.x,p.y,rad,0,Math.PI*2);ctx.fill();}
function scratched(){const w=cvs.width/devicePixelRatio,h=cvs.height/devicePixelRatio,img=ctx.getImageData(0,0,w,h).data;let clear=0,total=0,step=24*4;for(let i=3;i<img.length;i+=step){if(img[i]===0) clear++; total++;}return clear/total;}
function tryReveal(){if(!revealed&&scratched()>0.45){revealed=true;ctx.globalCompositeOperation="destination-out";ctx.fillRect(0,0,cvs.width,cvs.height);}}

cvs.addEventListener("mousedown",e=>{down=true;scratch(e);});
cvs.addEventListener("mousemove",e=>{if(down){scratch(e);tryReveal();}});
window.addEventListener("mouseup",()=>{down=false;});
cvs.addEventListener("touchstart",e=>{down=true;scratch(e);},{passive:true});
cvs.addEventListener("touchmove",e=>{if(down){scratch(e);tryReveal();}},{passive:true});
cvs.addEventListener("touchend",()=>{down=false;});
window.addEventListener("resize",sizeCanvas);
sizeCanvas();
</script>
